# Testing Dynamic Credentials

Before integrating with Kubernetes, let's manually test that dynamic credentials are working correctly.

## Generate Credentials

To manualy generate credentails for the database you can use the Vault CLI and the
role we created earlier:

```bash
vault read database/creds/demo-role
```

You'll see output like:

```
Key                Value
---                -----
lease_id           database/creds/demo-role/abc123...
lease_duration     1m
lease_renewable    true
password           A1a-randompassword123
username           v-root-demo-role-abc123...
```

Run the command again - you'll get different credentials each time! This is the power of dynamic secrets.

Vault connects to the database, creates a new user with the appropriate permissions, and returns the credentials to you. It then tracks the lease so it can revoke the user when the TTL expires.

## Connect to PostgreSQL

Let's use the generated credentials to connect to the database. First, generate credentials and capture them:

```bash
CREDS=$(vault read -format=json database/creds/demo-role)
DB_USER=$(echo $CREDS | jq -r '.data.username')
DB_PASS=$(echo $CREDS | jq -r '.data.password')
```

Now connect to PostgreSQL using those credentials:

```bash
PGPASSWORD=$DB_PASS psql -h 10.100.0.201 -U $DB_USER -d demo -c "SELECT current_user;"
```

You should see the dynamically generated username in the output.

## View Active Database Roles

You can see all the dynamically created roles in PostgreSQL:

```bash
PGPASSWORD=postgres psql -h 10.100.0.201 -U postgres -d demo -c "\du"
```

Note: This will fail if you've already rotated the root credentials. In that case, you can use Vault-generated credentials to check:

```bash
PGPASSWORD=$DB_PASS psql -h 10.100.0.201 -U $DB_USER -d demo -c "\du"
```

You'll see roles with names like `v-root-demo-role-...` - these are created by Vault.

## Observe Credential Expiration

Wait about 60 seconds (the TTL we configured) and try to connect again with the same credentials:

```bash
PGPASSWORD=$DB_PASS psql -h 10.100.0.201 -U $DB_USER -d demo -c "SELECT current_user;"
```

The connection will fail because the credentials have expired and been revoked. This automatic cleanup is a key security benefit of dynamic secrets.

Next, let's integrate these dynamic credentials with Kubernetes using the Vault Secrets Operator.
