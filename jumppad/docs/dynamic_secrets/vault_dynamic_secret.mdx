# Creating a VaultDynamicSecret

Now let's sync dynamic database credentials to Kubernetes using `VaultDynamicSecret`.

<Task id="create_dynamic_secret">

## VaultDynamicSecret Resource

The VaultDynamicSecret resource tells the Vault Secrets Operator to request dynamic credentials from Vault and sync them to a Kubernetes secret.

Create a file called `k8s/vault-dynamic-secret.yaml` with the following content and apply it using kubectl:

```yaml
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultDynamicSecret
metadata:
  name: demo-db-creds
  namespace: default
spec:
  vaultAuthRef: demo-auth
  mount: database
  path: creds/demo-role
  destination:
    name: demo-db-secret
    create: true
  renewalPercent: 67
```

Key fields:
- **vaultAuthRef** - References our VaultAuth resource
- **mount** - The secrets engine mount (`database`)
- **path** - Path to request credentials (`creds/demo-role`)
- **renewalPercent** - When to renew (at 67% of TTL, ~40 seconds)
- **destination.name** - Name of the Kubernetes secret to create

## Verify the Secret

Check that the Kubernetes secret was created:

```bash
kubectl get secret demo-db-secret -o jsonpath='{.data}' | jq -r 'to_entries[] | "\(.key): \(.value | @base64d)"'
```

</Task>

## Watch the Secret Rotate

With a 60-second TTL and 67% renewal, the secret will rotate approximately every 40 seconds. Watch it change:

```bash
watch -n 5 'kubectl get secret demo-db-secret -o jsonpath="{.data.username}" | base64 -d && echo'
```

You'll see the username change as new credentials are generated!

## Check the VaultDynamicSecret Status

```bash
kubectl describe vaultdynamicsecret demo-db-creds
```

This shows:
- Current lease information
- Last renewal time
- Any errors

## Verify in PostgreSQL

Connect to PostgreSQL and list the roles:

```bash
psql -h localhost -U postgres -d demo -c "\du"
```

You'll see the dynamically created roles from Vault. Old roles are automatically cleaned up when their leases expire.

## Clean Up

When you delete the VaultDynamicSecret, the lease is revoked and the database user is removed:

```bash
kubectl delete vaultdynamicsecret demo-db-creds
```

That completes the dynamic secrets section! You've learned how Vault can generate short-lived, unique database credentials that are automatically rotated and revoked.
