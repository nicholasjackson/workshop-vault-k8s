# Configuring the Vault Secrets Operator

We've verified that our service account can authenticate with Vault and read secrets. Now
let's configure the Vault Secrets Operator (VSO) to automate this process.

VSO uses Custom Resource Definitions (CRDs) to define how it should connect to Vault and
sync secrets. We need to create two resources:

1. **VaultConnection** - Defines how to connect to the Vault server
2. **VaultAuth** - Defines how to authenticate with Vault

## VaultConnection

The VaultConnection resource tells VSO where your Vault server is located. You typically
need one VaultConnection per namespace, though administrators can configure a default
cluster-wide connection when installing the operator.

The key configuration is the `address` field, which should point to your Vault server.
In production, this would use HTTPS with proper TLS certificates.

<Task id="configure_vso">

Create a file called `vault-connection.yaml` with the following content and apply
it using kubectl:

```yaml
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultConnection
metadata:
  name: vault
  namespace: default
spec:
  address: http://10.10.0.200:8200
```

Once the connection has been created, next we need to create a VaultAuth resource.

## VaultAuth

The VaultAuth resource tells VSO how to authenticate with Vault. It references:
- The VaultConnection to use
- The authentication method (Kubernetes in our case)
- The Vault role to authenticate as
- The Kubernetes service account to use

Create a file called `vault-auth.yaml` with the following content and apply 
to your cluster:

```yaml
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultAuth
metadata:
  name: demo-auth
  namespace: default
spec:
  vaultConnectionRef: vault
  method: kubernetes
  mount: kubernetes
  kubernetes:
    role: demo-app
    serviceAccount: demo-app
```

</Task>

## Understanding the VaultAuth Configuration

Let's break down the VaultAuth fields:

- **vaultConnectionRef** - References the VaultConnection resource by name. This tells VSO
  which Vault server to authenticate against.

- **method** - The Vault auth method to use. We're using `kubernetes`, but VSO also supports
  `jwt`, `appRole`, and others.

- **mount** - The path where the auth method is mounted in Vault. We enabled Kubernetes auth
  at the default `kubernetes` mount point.

- **kubernetes.role** - The Vault role to authenticate as. This must match a role we created
  with `vault write auth/kubernetes/role/...`.

- **kubernetes.serviceAccount** - The Kubernetes service account whose token will be used
  for authentication. This must match what's configured in the Vault role.

## Verifying the Configuration

You can check if VSO successfully authenticated by describing the VaultAuth resource:

```bash
kubectl describe vaultauth demo-auth
```

Look for the `Status` section - it should show that authentication was successful. If there
are errors, the events will show what went wrong.

## Next Steps

With authentication configured, we're ready for the final step: creating a VaultStaticSecret
to actually sync our secret from Vault to Kubernetes.
