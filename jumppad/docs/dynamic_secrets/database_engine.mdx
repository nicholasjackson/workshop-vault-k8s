# Configuring the Database Secrets Engine

Before we can use dynamic secrets in Kubernetes, we need to configure Vault's database secrets engine.

<Task id="configure_database_engine">

## Enable the Database Secrets Engine

First, enable the database secrets engine:

```bash
vault secrets enable database
```

## Configure the PostgreSQL Connection

Next, configure Vault to connect to our PostgreSQL database. This tells Vault how to create users:

```bash
vault write database/config/demo-db \
  plugin_name="postgresql-database-plugin" \
  allowed_roles="demo-role" \
  connection_url="postgresql://{{username}}:{{password}}@10.100.0.201:5432/demo?sslmode=disable" \
  username="postgres" \
  password="postgres"
```

Key configuration:
- **plugin_name** - The database plugin to use
- **allowed_roles** - Which roles can use this connection
- **connection_url** - Template URL with `{{username}}` and `{{password}}` placeholders
- **username/password** - Admin credentials Vault uses to create new users

If you look at the `connection_url`, you'll see it has the template variables `{{username}}` and `{{password}}`. Vault will replace these with the admin username and password to connect to the database.

```
postgresql://{{username}}:{{password}}@10.100.0.201:5432/demo?sslmode=disable
```

You can hard code the username and password directly in the URL, but using template variables is more secure. It also allows you to use a really nice feature of the database secrets engine - rotating the root credentials. Let's see how that works next.

</Task>

## Rotate the Root Credentials

When you use templated variables, Vault allows you to rotate the root credentials so that only Vault knows them. You can not retrieve this password later so you either need an alternate admin user or you
can use vault to generate credentials or you. 

Let's rotate the `postgres` user's password now:

```bash
vault write -force database/rotate-root/demo-db
```

After rotation, the original `postgres` password will no longer work - only Vault can access the database with admin privileges.

Let's verify that the rotation worked by trying to connect with the old password:

```bash
psql -h 10.100.0.201 -U postgres -d demo -c "\du"
```

You should see a connection error because the original `postgres` password no longer works - Vault has rotated it to a new random value that only Vault knows.

```bash
psql: error: connection to server at "10.100.0.201", port 5432 failed: FATAL:  password authentication failed for user "postgres"
```

Next, let's create a role that defines how to generate dynamic database credentials.